# AGITA - Atlassian-Github Issue Transfer Application

The purpose of this application is to support recreating Atlassian Jira issues
and comments as GitHub issues and comments.

To function the program requires two values from the execution environment:

* JIRA_TOKEN - Generated by a Jira user with administrative privileges on the source project(s).
* GITHUB_TOKEN - Generated by a GitHub user with administrative privileges the GitHub "uvalib" organization.

## OPERATIONAL DETAILS

### GitHub Rate Limits

Although the program can generate GitHub API requests very quickly once it has been received from the Jira API, GitHub has serveral
[rate limits](https://docs.github.com/en/rest/using-the-rest-api/rate-limits-for-the-rest-api)
which must be accommodated.

The primary rate limit is 5000 requests per hour, for API requests of any kind from the current IP address.
If this limit is hit, the program will pause until the reset time indicated by the GitHub API.
This limit might never be hit during a session when translating Jira projects of modest size.
For a Jira project with 10,000 issues, this limit will likely be hit twice.

There are a number of secondary rate limits that may apply, but the most stringent for the purposes of this program is that no more than 80 concurrent content-creating requests may be made per minute.
The GitHub API does not report on a reset time for any of these, so the program tracks batches of 80 instances and pauses enough time to ensure that the rate limit is not hit.

### GitHub Issue and Comment Formatting

The program attempts to translate the bodies of issues and comments from its original
[Jira Markdown](https://jira.atlassian.com/secure/WikiRendererHelpAction.jspa?section=all)
form into
GFM ([GitHub Flavored Markdown](https://github.github.com/gfm/)).
However, these are very different and Jira defines a lot of extensions which are not easily translated into GFM, and, in some cases, not translatable at all.
Depending on the nature of the original Jira content,
the GitHub translation may not be identical to the original.
Several Jira features have no GFM analogue:

* Jira autonumbered lists
* The Jira `{panel}` block
* The Jira `{color}` block and inline colored text

Each of these is "faked" by the program in order to yield something close to the expected results in GitHub.

The most problematic of these is colored text.
GitHub does not have direct support, however it does have support for inline LaTeX and that does have some level of support.
Unfortunately, Jira is very flexible in the way that colors can appear in the Markdown source and that is not always easily translatable into the LaTeX form.

### GitHub Results

Each Jira project ("PROJ") is transferred to a new private GitHub repository ("project-PROJ") which holds the translated issues/comments, and which may contain an "attachments" folder to hold any attachments associated with issues and/or comments.

To simplify management, each project is created with the Topic "jira-project" so that they can be all listed with:

> https://github.com/orgs/uvalib/repositories?q=topic%3Ajira-project

This was done because each translated Jira project needed to have storage for attachments,
which required making a standalone project for each transferred project.

### The Transfer Process

Import requests are handled asynchronously and queued internally by GitHub.
For small Jira projects with few issues and few comments, the complete transfer may be done by the time you list the issues of the newly-created GitHub repository.

For a Jira project with hundreds of issues and/or issues with many comments, it may take many minutes after the program completes before all of the issues appear in the new GitHub repository.

To simply the process, a `transfer` script is provided which allows you to run the program for a single Jira project while monitoring its activity, including the times at which a rate limit pause is being performed.

(In principle, the program could be run with `-transfer ALL` to transfer all known Jira projects, one after the other, however that has never actually been done in production.)

## USAGE

`agita mode [names...]`

The program can operate in one of these modes based on command line flag:

| Mode Flag                   | Names                    | Description                                                      |
|-----------------------------|--------------------------|------------------------------------------------------------------|
| -[transfer](#transfer-mode) | Jira projects (optional) | Create GitHub issues and comments from Jira issues and comments. |
| -[export](#export-mode)     | Jira projects (optional) | Generate JSON from Jira projects, issues, and comments.          |
| -[clear](#clear-mode)       | GitHub repos (required)  | Remove GitHub issues and comments.                               |
| -[trial](#trial-mode)       | (see below)              | Exercise Jira and GitHub APIs.                                   |

Exactly one mode must be supplied.

For modes that operate on Jira projects, if no arguments are given then all
organization Jira projects are assumed.


## LIMITATIONS

### Projects vs Repositories

There isn't a one-to-one mapping between Jira project and GitHub repo.
Some may not even be associated with any GitHub repo.
For example: Where would TDG (Technology Development Group) issues go?
Some have labels which might provide a clue; most do not.

It's not clear how Jira Service Management projects would fit into this.
Aside from lack of GitHub mappings, service desk functionality might be
difficult or impossible to duplicate in GitHub.

Currently, to resolve this limitation, the program always creates a private directory specific to the Jira project and does nothing with existing GitHub repos.

### Issues and Comments

The GitHub API is basically a programmatic way to access GitHub as an
alternative to the GitHub web client.
Because of this, its functionality is limited to the authenticated user in the
same way that functionality is limited on the web client.

When creating an issue or comment through the API you can provide a text body,
but you can't specify any metadata associated with the issue.
This means that a Jira issue or comment can't be directly translated into a
GitHub issue or comment because
- The original Jira ticket creator cannot be used to specify the creator of the GitHub issue.
- The original Jira ticket timestamp cannot be used to specify the creation date of the GitHub issue.

In principle, any Jira metadata could be prepended to GitHub issue or comment
bodies as comments, but the result is still that each issue and comment will
be owned by same GitHub user as the one who generated the GITHUB_SECRET key.


## TRANSFER MODE

Transferring Jira project issues and comments to GitHub issues and comments is
imprecise at best due to information loss between Jira items and their GitHub
counterparts.
This is due to:
* GitHub data structures lacking equivalent fields to their Jira counterparts.
* Technical limitations of the GitHub API as outlined below.

These issues are (partially) addressed by injecting annotations into the GitHub
issue and comment text bodies to ensure that values inexpressable as data
fields are still captured in the transferred result in some way.

### PROJECTS

Although there are large differences between the metadata for a Jira project
and a GitHub repository, these are mostly irrelevant to this program.
Currently, the program can only operate on Jira projects which have a known
one-to-one mapping with GitHub repositories.

The program does not attempt to create GitHub repositories (except temporary
fake repositories during execution of automated tests).

### ISSUES

Many `jira.Issue` fields are not usable by GitHub import, however some
information is important to understanding the nature of the original Jira
issue.
This information is included as lines at the beginning of IssueImport.Body
coming before the text of the original issue description.

| Field                                | Status | Destination                                                                                                                                    |
|--------------------------------------|--------|------------------------------------------------------------------------------------------------------------------------------------------------|
| Expand                               | -      |                                                                                                                                                |
| ID                                   | -      |                                                                                                                                                |
| Self                                 | -      |                                                                                                                                                |
| Key                                  | used   | as IssueImport.Body annotation                                                                                                                 |
| Fields.Expand                        | -      |                                                                                                                                                |
| Fields.Type                          | used   | as IssueImport.Body annotation                                                                                                                 |
| Fields.Project                       | -      |                                                                                                                                                |
| Fields.Environment                   | -      |                                                                                                                                                |
| Fields.Resolution                    | -      |                                                                                                                                                |
| Fields.Priority                      | used   | as IssueImport.Body annotation                                                                                                                 |
| Fields.Resolutiondate                | used   | as IssueImport.ClosedAt                                                                                                                        |
| Fields.Created                       | used   | as IssueImport.CreatedAt                                                                                                                       |
| Fields.Duedate                       | -      |                                                                                                                                                |
| Fields.Watches                       | -      |                                                                                                                                                |
| Fields.Assignee                      | used*  | as IssueImport.Assignee *if the Jira assignee has an equivalent GitHub account; otherwise it is included as an annotation to IssueImport.Body. |
| Fields.Updated                       | used   | as IssueImport.UpdatedAt                                                                                                                       |
| Fields.Description                   | used   | as IssueImport.Body                                                                                                                            |
| Fields.Summary                       | used   | as IssueImport.Title                                                                                                                           |
| Fields.Creator                       | used*  | as IssueImport.Body annotation *unless the same as Reporter                                                                                    |
| Fields.Reporter                      | used   | as IssueImport.Body annotation                                                                                                                 |
| Fields.Components                    | -      |                                                                                                                                                |
| Fields.Status                        | used   | as IssueImport.Body annotation                                                                                                                 |
| Fields.Progress                      | -      |                                                                                                                                                |
| Fields.AggregateProgress             | -      |                                                                                                                                                |
| Fields.TimeTracking                  | -      |                                                                                                                                                |
| Fields.TimeSpent                     | -      |                                                                                                                                                |
| Fields.TimeEstimate                  | -      |                                                                                                                                                |
| Fields.TimeOriginalEstimate          | -      |                                                                                                                                                |
| Fields.Worklog                       | -      |                                                                                                                                                |
| Fields.IssueLinks                    | -      |                                                                                                                                                |
| Fields.Comments                      | -      |                                                                                                                                                |
| Fields.FixVersions                   | -      |                                                                                                                                                |
| Fields.AffectsVersions               | -      |                                                                                                                                                |
| Fields.Labels                        | used   | as IssueImport.Labels                                                                                                                          |
| Fields.Subtasks                      | -      |                                                                                                                                                |
| Fields.Attachments                   | -      |                                                                                                                                                |
| Fields.Epic                          | -      |                                                                                                                                                |
| Fields.Sprint                        | -      |                                                                                                                                                |
| Fields.Parent                        | -      |                                                                                                                                                |
| Fields.AggregateTimeOriginalEstimate | -      |                                                                                                                                                |
| Fields.AggregateTimeSpent            | -      |                                                                                                                                                |
| Fields.AggregateTimeEstimate         | -      |                                                                                                                                                |
| Fields.Unknowns                      | -      |                                                                                                                                                |
| RenderedFields                       | -      |                                                                                                                                                |
| Changelog                            | -      |                                                                                                                                                |
| Transitions                          | -      |                                                                                                                                                |
| Names                                | -      |                                                                                                                                                |

Note that Creator/Reporter identities are limited to annotations because the
GitHub API will only create an issue with the identity of the user making the
request, nor does it support any way to modify the owner of the issue object
after the fact.

The identity of the Assignee is limited to an annotation if there is no mapping
of Jira account to GitHub account.
If there is, however, the issue can be created with that GitHub user assigned
to the issue.

### COMMENTS

Many `jira.Comment` fields are not usable by GitHub import, however some
information is important to understanding the nature of the original Jira
comment.
This information is included as lines at the beginning of CommentImport.Body
coming before the text of the original issue description.

| Field        | Status | Destination                                                 |
|--------------|--------|-------------------------------------------------------------|
| ID           | -      |                                                             |
| Self         | -      |                                                             |
| Name         | -      |                                                             |
| Author       | used   | as CommentImport.Body annotation                            |
| Body         | used   | as CommentImport.Body                                       |
| UpdateAuthor | used*  | as CommentImport.Body annotation *unless the same as Author |
| Updated      | used   | as CommentImport.Body annotation                            |
| Created      | used   | as CommentImport.CreatedAt                                  |
| Visibility   | used   | as CommentImport.Body annotation                            |

Note that the identity of the person who made the comment is only an
annotation.
The GitHub API does not support creating a comment object associated with any
user other than the user making the API request, nor does it support any way to
modify the owner of the comment object after the fact.


## EXPORT MODE

Jira project export is an alternative to attempting to fully transfer Jira
projects to GitHub repositories.

The output of this operating mode is a JSON array of projects.
Each project entry contains project metadata and an "Issues" key whose value is
an array of each issue associated with the project.

Each issue entry contains issue metadata and a "Comments" key whose value is an
array of each comment associated with the project.

The outputs of multiple Jira API calls are combined into a single JSON array of
nested values with redundant information fields eliminated in order to minify
the result.


## CLEAR MODE

This will remove issues and comments from one or more GitHub projects.

Although this may have its own uses, its primary purpose is to clean out
transferred Jira issues to prepare for a new transfer (presumably due to
improvements in the transfer process).


## TRIAL MODE

Engages functionality to demonstrate interaction with the Jira and GitHub APIs.

With no additional command line arguments, the specific functionality exercised
is controlled by the boolean constants at the top of `trial.go`.

If arguments are given, trials are limited to those specified:

    * all      - Perform all trials regardless of `trial.go` defaults
    * jira     - Demonstrate the Jira API
    * gihub    - Demonstrate the Github API
    * graphql  - Demonstrate GitHub GraphQL API
    * transfer - Simulate a transfer

Trials for Jira and GitHub can be limited to specific aspects

    * jira:projects
    * jira:issues
    * jira:comments
    * github:rate
    * github:users
    * github:repos
    * github:issues
    * github:comments

which can be combined with a comma, _e.g._, `agita -trial jira:issues,comments`


## REFERENCES

https://docs.github.com/en/rest/issues/issues#create-an-issue

https://pkg.go.dev/github.com/google/go-github/v69@v69.0.0/github

https://gist.github.com/jonmagic/5282384165e0f86ef105#supported-issue-and-comment-fields
